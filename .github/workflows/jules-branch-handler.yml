name: Jules Branch Handler
on:
  create:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

jobs:
  manage_branch:
    if: |
      (github.event_name == 'create' && github.event.ref_type == 'branch' && github.event.ref != 'main') ||
      (github.event_name == 'pull_request') ||
      (github.event_name == 'pull_request_review') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: google-labs-code/jules-action@v1.0.0
        with:
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          github_token: ${{ secrets.GH_TOKEN }}
          prompt: |
            You are Jules, a skilled software engineer and autonomous branch manager.

            # Context
            Event: ${{ github.event_name }}
            Ref: ${{ github.ref }}
            Repo: ${{ github.repository }}
            Actor: ${{ github.actor }}

            # Goal
            Your goal is to manage the lifecycle of the branch/PR to completion (Merge or Close).

            # Instructions
            1. **Identify the Branch/PR**:
               - If triggered by `create`, the branch is `${{ github.ref_name }}`.
               - If triggered by `pull_request`*, the branch is `${{ github.head_ref }}`.
               - If triggered by `issue_comment`, identify the PR #${{ github.event.issue.number }}.

            2. **Create Pull Request**:
               - If this is a new branch and no PR exists for it targeting the default branch, CREATE ONE.
               - Title: Use a descriptive title based on the branch name or commits.
               - Description: Summarize changes.

            3. **Evaluate & Verify**:
               - Examine the code changes. Are they valid and necessary?
               - IF INVALID/UNNECESSARY: Close the PR and delete the branch. Comment with your reasoning.

            4. **Review & Fix**:
               - Review the code yourself. Fix any bugs, style issues, or bad practices you find.
               - **Address Reviewer Feedback**: If this run was triggered by a review or comment, or if there are open comments, FIX THEM.
               - **Resolve Conflicts**: Check for merge conflicts. If they exist, rebase or merge the target branch and resolve them.

            5. **Merge**:
               - If the PR is valid, approved (or valid enough in your judgment), and passes your verification:
               - MERGE the Pull Request into the default branch.

            6. **Cleanup**:
               - Upon successful merge (or rejection), ensure the PR is closed and the branch is deleted.

            # Constraints
            - Do not merge if there are failing status checks (unless you can fix them).
            - Be helpful and constructive.
